//
//  LiveCameraRouletteView.swift
//  UnluckyDraw
//
//  Created on 2025-06-16
//

import SwiftUI
import AVFoundation
import Vision

struct LiveCameraRouletteView: View {
    @Environment(\.dismiss) private var dismiss
    @StateObject private var liveCameraController = LiveCameraRouletteController()
    
    @State private var showingResult = false
    @State private var winner: DetectedFace?
    
    var body: some View {
        ZStack {
            // ë°°ê²½ìƒ‰
            Color.black.ignoresSafeArea()
            
            VStack(spacing: 0) {
                // Navigation Bar
                HStack {
                    Button(action: { dismiss() }) {
                        Image(systemName: "xmark")
                            .font(.title2)
                            .foregroundColor(.white)
                    }
                    
                    Spacer()
                    
                    Text("Live Camera Draw")
                        .font(.headline)
                        .fontWeight(.semibold)
                        .foregroundColor(.white)
                    
                    Spacer()
                    
                    Button(action: { 
                        liveCameraController.toggleCamera()
                    }) {
                        Image(systemName: "camera.rotate.fill")
                            .font(.title2)
                            .foregroundColor(.white)
                    }
                }
                .padding()
                .background(Color.black.opacity(0.7))
                
                // ë©”ì¸ ì¹´ë©”ë¼ + ì˜¤ë²„ë ˆì´ ì˜ì—­
                GeometryReader { geometry in
                    ZStack {
                        // ì¹´ë©”ë¼ ê¶Œí•œ ìƒíƒœì— ë”°ë¥¸ í‘œì‹œ
                        switch liveCameraController.cameraPermissionStatus {
                        case .granted:
                            // ì‹¤ì‹œê°„ ì¹´ë©”ë¼ í”¼ë“œ
                            LiveCameraPreview(controller: liveCameraController)
                                .clipShape(RoundedRectangle(cornerRadius: 12))
                                .overlay(
                                    RoundedRectangle(cornerRadius: 12)
                                        .stroke(Color.gray.opacity(0.3), lineWidth: 1)
                                )
                        
                        case .denied, .restricted:
                            // ê¶Œí•œ ê±°ë¶€ë¨
                            VStack(spacing: 16) {
                                Image(systemName: "camera.fill")
                                    .font(.system(size: 50))
                                    .foregroundColor(.gray)
                                
                                Text("Camera Access Required")
                                    .font(.headline)
                                    .foregroundColor(.white)
                                
                                Text("Please enable camera access in Settings to use this feature")
                                    .font(.caption)
                                    .foregroundColor(.gray)
                                    .multilineTextAlignment(.center)
                                    .padding(.horizontal)
                                
                                Button("Open Settings") {
                                    if let settingsUrl = URL(string: UIApplication.openSettingsURLString) {
                                        UIApplication.shared.open(settingsUrl)
                                    }
                                }
                                .foregroundColor(.primaryRed)
                                .padding()
                                .background(Color.white)
                                .cornerRadius(10)
                            }
                            .frame(maxWidth: .infinity, maxHeight: .infinity)
                            .background(Color.black)
                            .clipShape(RoundedRectangle(cornerRadius: 12))
                        
                        default:
                            // ë¡œë”© ì¤‘
                            VStack(spacing: 16) {
                                ProgressView()
                                    .scaleEffect(1.5)
                                    .tint(.white)
                                
                                Text("Initializing Camera...")
                                    .font(.headline)
                                    .foregroundColor(.white)
                            }
                            .frame(maxWidth: .infinity, maxHeight: .infinity)
                            .background(Color.black)
                            .clipShape(RoundedRectangle(cornerRadius: 12))
                        }
                        
                        // ì–¼êµ´ ê°ì§€ ì˜¤ë²„ë ˆì´ (ê¶Œí•œì´ ìˆì„ ë•Œë§Œ)
                        if liveCameraController.cameraPermissionStatus == .granted {
                            FaceTrackingOverlay(
                                detectedFaces: liveCameraController.detectedFaces,
                                currentHighlightedIndex: liveCameraController.currentHighlightedIndex,
                                isSpinning: liveCameraController.isSpinning,
                                previewSize: geometry.size,
                                cameraPosition: liveCameraController.cameraPosition
                            )
                            
                            // ë£°ë › ìŠ¤í”¼ë‹ ì´í™íŠ¸
                            if liveCameraController.isSpinning {
                                SpinningEffectOverlay()
                            }
                            
                            // ë‹¹ì²¨ í™•ëŒ€ íš¨ê³¼
                            if let winnerFace = liveCameraController.winner, !liveCameraController.isSpinning {
                                WinnerZoomOverlay(
                                    winner: winnerFace,
                                    previewSize: geometry.size,
                                    cameraPosition: liveCameraController.cameraPosition,
                                    capturedWinnerImage: liveCameraController.capturedWinnerImage
                                )
                            }
                        }
                    }
                }
                .padding(.horizontal, 16)
                
                // í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„
                VStack(spacing: 16) {
                    // ìƒíƒœ í‘œì‹œ
                    HStack {
                        Circle()
                            .fill(liveCameraController.detectedFaces.isEmpty ? Color.gray : Color.green)
                            .frame(width: 8, height: 8)
                        
                        Text("\(liveCameraController.detectedFaces.count) faces detected")
                            .font(.caption)
                            .foregroundColor(.white)
                        
                        Spacer()
                        
                        // ë£°ë › ìƒíƒœ í‘œì‹œ
                        if liveCameraController.isSpinning {
                            HStack(spacing: 8) {
                                ProgressView()
                                    .scaleEffect(0.8)
                                    .tint(.highlightYellow)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("ğŸ° DRAWING...")
                                        .font(.caption)
                                        .fontWeight(.bold)
                                        .foregroundColor(.highlightYellow)
                                    
                                    Text("Finding the unlucky one")
                                        .font(.caption2)
                                        .foregroundColor(.gray)
                                }
                            }
                        } else if liveCameraController.winner != nil {
                            HStack(spacing: 8) {
                                Text("ğŸ†")
                                    .font(.title2)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("WINNER SELECTED!")
                                        .font(.caption)
                                        .fontWeight(.bold)
                                        .foregroundColor(.highlightYellow)
                                    
                                    Text("Tap Reset to draw again")
                                        .font(.caption2)
                                        .foregroundColor(.gray)
                                }
                            }
                        }
                    }
                    
                    // ì°¸ê°€ì í‘œì‹œ (ì¶”ì²¨ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)
                    if !liveCameraController.isSpinning && liveCameraController.detectedFaces.count > 1 && liveCameraController.winner == nil {
                        HStack(spacing: 8) {
                            Text("Participants:")
                                .font(.caption)
                                .foregroundColor(.gray)
                            
                            ForEach(0..<liveCameraController.detectedFaces.count, id: \.self) { index in
                                Circle()
                                    .fill(Color.primaryRed)
                                    .frame(width: 6, height: 6)
                            }
                            
                            Spacer()
                        }
                    }
                    
                    // ì¶”ì²¨ ì¤‘ ì°¸ê°€ì í‘œì‹œ
                    if liveCameraController.isSpinning && liveCameraController.detectedFaces.count > 1 {
                        HStack(spacing: 8) {
                            Text("Drawing from:")
                                .font(.caption)
                                .foregroundColor(.gray)
                            
                            ForEach(0..<liveCameraController.detectedFaces.count, id: \.self) { index in
                                Circle()
                                    .fill(index == liveCameraController.currentHighlightedIndex ? 
                                          Color.highlightYellow : Color.gray.opacity(0.4))
                                    .frame(width: 8, height: 8)
                                    .scaleEffect(index == liveCameraController.currentHighlightedIndex ? 1.5 : 1.0)
                                    .animation(.easeInOut(duration: 0.2), value: liveCameraController.currentHighlightedIndex)
                            }
                            
                            Spacer()
                        }
                    }
                    
                    // ì•¡ì…˜ ë²„íŠ¼
                    HStack(spacing: 20) {
                        // ë£°ë › ì‹œì‘/ì •ì§€ ë²„íŠ¼
                        Button(action: {
                            HapticManager.impact()
                            if liveCameraController.isSpinning {
                                liveCameraController.stopRoulette()
                            } else if liveCameraController.detectedFaces.count >= 2 && liveCameraController.winner == nil {
                                liveCameraController.startRoulette()
                            }
                        }) {
                            HStack(spacing: 8) {
                                if liveCameraController.isSpinning {
                                    Image(systemName: "stop.circle.fill")
                                    Text("Stop Draw")
                                } else {
                                    Image(systemName: "play.circle.fill")
                                    Text("Start Draw")
                                }
                            }
                            .foregroundColor(.white)
                            .font(.headline)
                            .padding(.vertical, 14)
                            .padding(.horizontal, 24)
                            .background(
                                getButtonBackgroundColor()
                            )
                            .cornerRadius(12)
                        }
                        .disabled(
                            (!liveCameraController.isSpinning && liveCameraController.detectedFaces.count < 2) ||
                            liveCameraController.winner != nil
                        )
                        
                        // ë¦¬ì…‹ ë²„íŠ¼
                        if liveCameraController.winner != nil {
                            Button(action: {
                                HapticManager.impact()
                                liveCameraController.reset()
                            }) {
                                HStack(spacing: 8) {
                                    Image(systemName: "arrow.clockwise")
                                    Text("Reset")
                                }
                                .foregroundColor(.white)
                                .font(.headline)
                                .padding(.vertical, 14)
                                .padding(.horizontal, 24)
                                .background(Color.gray)
                                .cornerRadius(12)
                            }
                        }
                    }
                    
                    // ì•ˆë‚´ ë©”ì‹œì§€
                    Group {
                        if liveCameraController.detectedFaces.isEmpty {
                            Text("ğŸ“· Position faces in the camera view")
                                .font(.caption)
                                .foregroundColor(.gray)
                                .multilineTextAlignment(.center)
                        } else if liveCameraController.detectedFaces.count == 1 {
                            Text("ğŸ‘¥ Add more people to start the draw")
                                .font(.caption)
                                .foregroundColor(.gray)
                                .multilineTextAlignment(.center)
                        } else if liveCameraController.isSpinning {
                            Text("ğŸ° Drawing in progress... Wait for the result!")
                                .font(.caption)
                                .fontWeight(.medium)
                                .foregroundColor(.highlightYellow)
                                .multilineTextAlignment(.center)
                        } else if liveCameraController.winner != nil {
                            Text("ğŸ‰ Winner selected! Use Reset to draw again")
                                .font(.caption)
                                .fontWeight(.medium)
                                .foregroundColor(.highlightYellow)
                                .multilineTextAlignment(.center)
                        } else {
                            Text("âœ… Ready to draw! Tap Start Draw to begin")
                                .font(.caption)
                                .fontWeight(.medium)
                                .foregroundColor(.winnerGreen)
                                .multilineTextAlignment(.center)
                        }
                    }
                }
                .padding()
                .background(Color.black.opacity(0.8))
            }
        }
        .navigationBarHidden(true)
        .onAppear {
            liveCameraController.startCamera()
        }
        .onDisappear {
            liveCameraController.stopCamera()
        }
    }
    
    // MARK: - Helper Functions
    private func getButtonBackgroundColor() -> Color {
        if liveCameraController.isSpinning {
            return Color.primaryOrange
        } else if liveCameraController.detectedFaces.count >= 2 && liveCameraController.winner == nil {
            return Color.primaryRed
        } else {
            return Color.gray
        }
    }
}

// MARK: - Live Camera Preview
struct LiveCameraPreview: UIViewRepresentable {
    let controller: LiveCameraRouletteController
    
    func makeUIView(context: Context) -> UIView {
        let view = UIView()
        view.backgroundColor = UIColor.black
        
        // previewLayerê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
            self.setupPreviewLayer(in: view)
        }
        
        return view
    }
    
    func updateUIView(_ uiView: UIView, context: Context) {
        // ë ˆì´ì–´ í”„ë ˆì„ ì—…ë°ì´íŠ¸
        DispatchQueue.main.async {
            if let previewLayer = controller.previewLayer {
                previewLayer.frame = uiView.bounds
                
                // ë ˆì´ì–´ê°€ ì•„ì§ ì¶”ê°€ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì¶”ê°€
                if previewLayer.superlayer == nil {
                    uiView.layer.addSublayer(previewLayer)
                }
            }
        }
    }
    
    private func setupPreviewLayer(in view: UIView) {
        guard let previewLayer = controller.previewLayer else {
            print("âŒ PreviewLayer is nil")
            return
        }
        
        // ê¸°ì¡´ ë ˆì´ì–´ ì œê±°
        view.layer.sublayers?.removeAll()
        
        // ìƒˆ ë ˆì´ì–´ ì„¤ì •
        previewLayer.frame = view.bounds
        previewLayer.videoGravity = .resizeAspectFill
        view.layer.addSublayer(previewLayer)
        
        print("âœ… PreviewLayer added to view")
    }
}

// MARK: - Face Tracking Overlay
struct FaceTrackingOverlay: View {
    let detectedFaces: [DetectedFace]
    let currentHighlightedIndex: Int
    let isSpinning: Bool
    let previewSize: CGSize
    let cameraPosition: AVCaptureDevice.Position
    
    var body: some View {
        ZStack {
            ForEach(Array(detectedFaces.enumerated()), id: \.element.id) { index, face in
                LiveFaceOverlay(
                    face: face,
                    index: index,
                    isHighlighted: index == currentHighlightedIndex,
                    isSpinning: isSpinning,
                    previewSize: previewSize,
                    cameraPosition: cameraPosition
                )
            }
        }
    }
}

// MARK: - Live Face Overlay
struct LiveFaceOverlay: View {
    let face: DetectedFace
    let index: Int
    let isHighlighted: Bool
    let isSpinning: Bool
    let previewSize: CGSize
    let cameraPosition: AVCaptureDevice.Position
    
    var body: some View {
        let convertedBox = convertVisionToPreviewRect(face.boundingBox, previewSize: previewSize, cameraPosition: cameraPosition)
        
        ZStack {
            // ê¸°ë³¸ ì–¼êµ´ ì‚¬ê°í˜• (í•­ìƒ í‘œì‹œ)
            if !isSpinning {
                Rectangle()
                    .stroke(Color.primaryRed.opacity(0.7), lineWidth: 2)
                    .background(Color.primaryRed.opacity(0.05))
                    .frame(width: convertedBox.width, height: convertedBox.height)
                    .position(x: convertedBox.midX, y: convertedBox.midY)
                
                // ì–¼êµ´ ë²ˆí˜¸
                Text("\(index + 1)")
                    .font(.system(size: 12, weight: .bold))
                    .foregroundColor(.white)
                    .padding(6)
                    .background(
                        Circle()
                            .fill(Color.primaryRed)
                            .shadow(color: .black.opacity(0.3), radius: 2)
                    )
                    .position(
                        x: convertedBox.minX + 15,
                        y: convertedBox.minY + 15
                    )
            }
            
            // ì¶”ì²¨ ì¤‘ì¼ ë•Œë§Œ í•˜ì´ë¼ì´íŠ¸ í‘œì‹œ
            if isSpinning && isHighlighted {
                // ë©”ì¸ í•˜ì´ë¼ì´íŠ¸ ì‚¬ê°í˜•
                Rectangle()
                    .stroke(Color.highlightYellow, lineWidth: 4)
                    .background(Color.highlightYellow.opacity(0.2))
                    .frame(width: convertedBox.width * 1.2, height: convertedBox.height * 1.2)
                    .position(x: convertedBox.midX, y: convertedBox.midY)
                    .scaleEffect(1.05)
                
                // íœì‹± í…Œë‘ë¦¬
                Rectangle()
                    .stroke(Color.highlightYellow, lineWidth: 2)
                    .frame(width: convertedBox.width * 1.3, height: convertedBox.height * 1.3)
                    .position(x: convertedBox.midX, y: convertedBox.midY)
                    .opacity(0.6)
                    .scaleEffect(1.1)
                    .animation(.easeInOut(duration: 0.3).repeatForever(autoreverses: true), value: isHighlighted)
                
                // í•˜ì´ë¼ì´íŠ¸ëœ ë²ˆí˜¸
                Text("\(index + 1)")
                    .font(.system(size: 16, weight: .black))
                    .foregroundColor(.black)
                    .padding(8)
                    .background(
                        Circle()
                            .fill(Color.highlightYellow)
                            .shadow(color: .highlightYellow.opacity(0.5), radius: 4)
                    )
                    .position(
                        x: convertedBox.minX + 20,
                        y: convertedBox.minY + 20
                    )
                    .scaleEffect(1.2)
            }
        }
    }
    
    // Vision ì¢Œí‘œë¥¼ ë¯¸ë¦¬ë³´ê¸° ì¢Œí‘œë¡œ ì •í™•íˆ ë³€í™˜
    private func convertVisionToPreviewRect(_ visionRect: CGRect, previewSize: CGSize, cameraPosition: AVCaptureDevice.Position) -> CGRect {
        // Vision ì¢Œí‘œëŠ” (0,0)ì´ ì¢Œí•˜ë‹¨, UIKitì€ ì¢Œìƒë‹¨
        var normalizedRect = visionRect
        
        // Y ì¢Œí‘œ ë³€í™˜ (ì¢Œí•˜ë‹¨ -> ì¢Œìƒë‹¨)
        normalizedRect.origin.y = 1.0 - visionRect.origin.y - visionRect.size.height
        
        // ì „ë©´ ì¹´ë©”ë¼ì¸ ê²½ìš° X ì¢Œí‘œ ë¯¸ëŸ¬ë§
        if cameraPosition == .front {
            normalizedRect.origin.x = 1.0 - visionRect.origin.x - visionRect.size.width
        }
        
        // ë¯¸ë¦¬ë³´ê¸° í¬ê¸°ì— ë§ê²Œ ìŠ¤ì¼€ì¼ë§
        return CGRect(
            x: normalizedRect.origin.x * previewSize.width,
            y: normalizedRect.origin.y * previewSize.height,
            width: normalizedRect.size.width * previewSize.width,
            height: normalizedRect.size.height * previewSize.height
        )
    }
}

// MARK: - Spinning Effect Overlay
struct SpinningEffectOverlay: View {
    @State private var rotationAngle: Double = 0
    
    var body: some View {
        ZStack {
            // ì¤‘ì•™ ìŠ¤í”¼ë‹ ì¸ë””ì¼€ì´í„°
            VStack(spacing: 8) {
                ZStack {
                    Circle()
                        .stroke(Color.highlightYellow.opacity(0.3), lineWidth: 3)
                        .frame(width: 60, height: 60)
                    
                    ForEach(0..<8) { index in
                        Rectangle()
                            .fill(Color.highlightYellow.opacity(0.8))
                            .frame(width: 2, height: 12)
                            .offset(y: -24)
                            .rotationEffect(.degrees(Double(index) * 45 + rotationAngle))
                    }
                }
                
                Text("ğŸ° Spinning...")
                    .font(.caption)
                    .fontWeight(.bold)
                    .foregroundColor(.highlightYellow)
                    .shadow(color: .black.opacity(0.5), radius: 2)
            }
        }
        .onAppear {
            withAnimation(.linear(duration: 0.8).repeatForever(autoreverses: false)) {
                rotationAngle = 360
            }
        }
    }
}

// MARK: - Winner Zoom Overlay
struct WinnerZoomOverlay: View {
    let winner: DetectedFace
    let previewSize: CGSize
    let cameraPosition: AVCaptureDevice.Position
    let capturedWinnerImage: UIImage?
    
    @State private var showAnimation = false
    @State private var scale: CGFloat = 0.8
    @State private var rotationAngle: Double = 0
    
    var body: some View {
        ZStack {
            // ë°˜íˆ¬ëª… ë°°ê²½
            Color.black.opacity(0.85)
                .ignoresSafeArea()
                .onTapGesture {
                    // íƒ­í•˜ë©´ íš¨ê³¼ ì¢…ë£Œ
                    withAnimation(.easeOut(duration: 0.3)) {
                        showAnimation = false
                    }
                }
            
            if showAnimation {
                VStack(spacing: 30) {
                    // ë‹¹ì²¨ íƒ€ì´í‹€
                    VStack(spacing: 12) {
                        Text("ğŸ†")
                            .font(.system(size: 50))
                            .scaleEffect(showAnimation ? 1.1 : 0.8)
                            .animation(.spring(response: 0.6, dampingFraction: 0.6), value: showAnimation)
                        
                        Text("UNLUCKY WINNER!")
                            .font(.title)
                            .fontWeight(.bold)
                            .foregroundColor(.primaryRed)
                            .scaleEffect(showAnimation ? 1.0 : 0.5)
                            .animation(.spring(response: 0.8, dampingFraction: 0.7).delay(0.2), value: showAnimation)
                    }
                    
                    // ëŒ€í˜• ì–¼êµ´ ì´ë¯¸ì§€ (ì¤‘ì•™ ê³ ì •)
                    if let capturedFace = capturedWinnerImage {
                        VStack(spacing: 16) {
                            // ëŒ€í˜• ì–¼êµ´ ì´ë¯¸ì§€
                            Image(uiImage: capturedFace)
                                .resizable()
                                .aspectRatio(contentMode: .fill)
                                .frame(width: 200, height: 200)
                                .clipShape(Circle())
                                .overlay(
                                    Circle()
                                        .stroke(
                                            LinearGradient(
                                                gradient: Gradient(colors: [.winnerGreen, .primaryOrange]),
                                                startPoint: .topLeading,
                                                endPoint: .bottomTrailing
                                            ),
                                            lineWidth: 8
                                        )
                                )
                                .shadow(color: .winnerGreen.opacity(0.5), radius: 20)
                                .scaleEffect(scale)
                                .overlay(
                                    // í¬ë¼ìš´ ì˜¤ë²„ë ˆì´
                                    Image(systemName: "crown.fill")
                                        .font(.system(size: 24))
                                        .foregroundColor(.primaryOrange)
                                        .rotationEffect(.degrees(rotationAngle))
                                        .shadow(color: .black.opacity(0.3), radius: 2)
                                        .offset(y: -120)
                                )
                            
                            // ë‹¹ì²¨ì í…ìŠ¤íŠ¸
                            Text("ğŸ† THE UNLUCKY ONE")
                                .font(.title2)
                                .fontWeight(.black)
                                .foregroundColor(.white)
                                .padding(.horizontal, 20)
                                .padding(.vertical, 10)
                                .background(
                                    Capsule()
                                        .fill(
                                            LinearGradient(
                                                gradient: Gradient(colors: [.primaryRed, .primaryOrange]),
                                                startPoint: .leading,
                                                endPoint: .trailing
                                            )
                                        )
                                        .shadow(color: .primaryRed.opacity(0.5), radius: 8)
                                )
                                .scaleEffect(scale)
                        }
                    } else {
                        // ì–¼êµ´ ìº¡ì³ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ í‘œì‹œ
                        VStack(spacing: 16) {
                            Circle()
                                .fill(Color.gray.opacity(0.3))
                                .frame(width: 200, height: 200)
                                .overlay(
                                    Image(systemName: "person.fill")
                                        .font(.system(size: 80))
                                        .foregroundColor(.gray)
                                )
                                .overlay(
                                    Circle()
                                        .stroke(Color.primaryRed, lineWidth: 8)
                                )
                                .scaleEffect(scale)
                            
                            Text("ğŸ† THE UNLUCKY ONE")
                                .font(.title2)
                                .fontWeight(.black)
                                .foregroundColor(.white)
                                .padding(.horizontal, 20)
                                .padding(.vertical, 10)
                                .background(
                                    Capsule()
                                        .fill(Color.primaryRed)
                                        .shadow(color: .primaryRed.opacity(0.5), radius: 8)
                                )
                                .scaleEffect(scale)
                        }
                    }
                    
                    Spacer()
                    
                    // í•˜ë‹¨ ì•ˆë‚´ ë©”ì‹œì§€
                    VStack(spacing: 12) {
                        Text("ğŸ‰ Congratulations! ğŸ‰")
                            .font(.title2)
                            .fontWeight(.bold)
                            .foregroundColor(.highlightYellow)
                        
                        Text("Tap anywhere to continue or use Reset to draw again")
                            .font(.caption)
                            .foregroundColor(.gray)
                            .multilineTextAlignment(.center)
                    }
                    .padding(.bottom, 40)
                    .opacity(showAnimation ? 1.0 : 0.0)
                    .animation(.easeInOut.delay(0.8), value: showAnimation)
                }
                .transition(.opacity.combined(with: .scale))
            }
        }
        .onAppear {
            // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            showAnimation = true
            
            // ì„±ê³µ í–„í‹± í”¼ë“œë°±
            HapticManager.notification(.success)
            
            // ì–¼êµ´ í™•ëŒ€ ì• ë‹ˆë©”ì´ì…˜
            withAnimation(.spring(response: 0.8, dampingFraction: 0.8, blendDuration: 0)) {
                scale = 1.0
            }
            
            // í¬ë¼ìš´ íšŒì „ íš¨ê³¼
            DispatchQueue.main.asyncAfter(deadline: .now() + 0.8) {
                withAnimation(.easeInOut(duration: 4.0).repeatForever(autoreverses: true)) {
                    rotationAngle = 6
                }
            }
        }
    }
    
    // ë¼ì´ë¸Œ ì¹´ë©”ë¼ì—ì„œ ì–¼êµ´ ìº¡ì³
    private func captureWinnerFace() -> UIImage? {
        // í˜„ì¬ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë¯€ë¡œ ê¸°ë³¸ í‘œì‹œë¥¼ ì‚¬ìš©
        // ë‚˜ì¤‘ì— ì‹¤ì œ ì¹´ë©”ë¼ í”„ë ˆì„ì—ì„œ ì–¼êµ´ì„ ìº¡ì³í•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŒ
        return nil
    }
}

#Preview {
    LiveCameraRouletteView()
}
